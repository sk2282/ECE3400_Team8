<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Lab 3</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  </head>
  
  <style>
    .jumbotron { 
        background-color: #000000; /* Black */
        background-image: url(https://i.imgur.com/GmhOaGq.jpg);
        background-size: cover;
        background-repeat: no-repeat;  
        color: #FFFB00; /* Yellow */
        height: 100vh;
        padding: 100px 25px;
        align-items: center;
    }
    
    .container-fluid {
        padding: 60px 50px;
    }
    
    .bg-blk {
        background-color: #000000;
    }
    
    .txt-white {
        color: #fff;
    }
    
    .txt-yellow {
        color: #FFFB00;
    }
    
    .navbar {
        margin-bottom: 0;
        background-color: #000;
        z-index: 9999;
        border: 0;
        font-size: 12px !important;
        line-height: 1.42857143 !important;
        letter-spacing: 4px;
        border-radius: 0;
    }
    .navbar li a, .navbar .navbar-brand {
        color: #FFFB00 !important;
    }
    .navbar-nav li a:hover, .navbar-nav li.active a {
        color: #000 !important;
        background-color: #FFFB00 !important;
    }
    .navbar-default .navbar-toggle {
        border-color: transparent;
        color: #FFFB00 !important;
    }

    header .glyphicon {
        font-size: 20px;
        margin-bottom: 0px;
        color: #FFFB00;
        background-color: transparent;
    }
    
    footer .glyphicon {
        font-size: 20px;
        margin-bottom: 20px;
        color: #FFFB00;
    }
    body {
      background-color: #000;
        cursor: url(https://github.com/sk2282/ECE3400_Team8/blob/master/pictures/General/bb-8_cursor.png?raw=true), auto;
    }
    a {
       color: #FFFF00;
    }
    a:hover, a:focus {
      color: #FFFF00;
      text-decoration: underline;
      cursor: url(https://github.com/sk2282/ECE3400_Team8/blob/master/pictures/General/LightSaber_Blue.cur?raw=true), auto;
    }
  </style>

  <body>
  
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span> 
          </button>
          <a class="navbar-brand" href="#myPage">
            <span class="glyphicon glyphicon-king"></span>
          </a>
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://sk2282.github.io/ECE3400_Team8/">HOME</a></li>
            
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">MILESTONES
              <span class="caret"></span></a>
              <ul class="dropdown-menu bg-blk">
                <li><a href="https://sk2282.github.io/ECE3400_Team8/milestone1">Milestone 1</a></li>
                <li><a href="https://sk2282.github.io/ECE3400_Team8/milestone2">Milestone 2</a></li>
                <li><a href="https://sk2282.github.io/ECE3400_Team8/milestone3">Milestone 3</a></li>
                <li><a href="https://sk2282.github.io/ECE3400_Team8/milestone4">Milestone 4</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">LABS
              <span class="caret"></span></a>
              <ul class="dropdown-menu bg-blk">
                <li><a href="https://sk2282.github.io/ECE3400_Team8/lab1">Lab 1</a></li>
                <li><a href="https://sk2282.github.io/ECE3400_Team8/lab2">Lab 2</a></li>
                <li><a href="https://sk2282.github.io/ECE3400_Team8/lab4">Lab 4</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a class="dropdown-toggle" data-toggle="dropdown" href="#">LINKS
              <span class="caret"></span></a>
              <ul class="dropdown-menu bg-blk">
                <li><a href="https://github.com/sk2282/ECE3400_Team8">GitHub</a></li>
                <li><a href="https://sk2282.github.io/ECE3400_Team8/minutes">Meeting Minutes</a></li>
                <li><a href="https://sk2282.github.io/ECE3400_Team8/ethics">Ethics Homework</a></li>
                <li><a href="https://sk2282.github.io/ECE3400_Team8/cost">Robot Cost</a></li>
                <li><a href="https://www.sparkfun.com/products/9453">Line Sensor Info</a></li>
                <li><a href="https://www.fairchildsemi.com/datasheets/LM/LM358A.pdf">Op Amp Data Sheet</a></li>
              </ul>
            </li>

            <li><a href="https://sk2282.github.io/ECE3400_Team8/final">DESIGN</a></li>                      
          </ul>

        </div>
      </div>
    </nav>
  
    <!--TITLE-->
    <div id="myPage" class="jumbotron text-center">
      <br><br><br><br><br><br><br><br><br><br>
      <br><br><br>
      <!--<h1>LAB</h1> -->
      <p><i>FPGA</i></p> 
      <div class="container">
          <header class="container-fluid text-center">
            <a href="#content" title="Enter">
              <span class="glyphicon glyphicon-chevron-down"></span>
            </a> 
          </header>
      </div>
    </div>
    <div style="padding:0 10%">
    <!--THIS IS WHERE THE TEXT WILL GO-->
    <div id="content" class="container-fluid bg-blk txt-white">
      <div class="row">
        
      <!--start-->
      <h4>Objective:</h4>
        The objective of this lab is to work with an FPGA to begin the monitor display for the final robot as well as having the robot generate a "tune" using at least 3 tones.

        <h4>Team Division:</h4>
          <ul>
            <li>Graphics: Rohit Krishnakumar, Alice Song, Victoria Tu</li>
            <li>Audio: Meghan Chen, Serena Krech, Michael Yee</li>
          </ul>

        <h4>Graphics Team:</h4>
        Materials Used:
          <ul>
            <li>FPGA</li>
            <li>VGA switch</li>
            <li>Monitor</li>
            <li>Arduino</li>
            <li>Resistors: 1.7kOhms and 3.3kOhms</li>
          </ul>

        <h4>Procedure:</h4>
          <ol>
            <li>Download example code on the FPGA</li>
            <li>Modify code to display a 2x2 grid</li>
            <li>Modify code to change grid color depending from the two switches</li>
          </ol>

        <h5>1. Download example code on the FPGA:</h5>
          <ul>
            <li>Used VGA connector to connect the FPGA GPIO pins to the VGA switch</li>
            <li>Example code showed green screen on monitor and flashed green LED
            <br>
            <img src="https://github.com/sk2282/ECE3400_Team8/blob/master/pictures/Lab3/GraphicsGreenScreen.jpg?raw=true" height="300" />
            </li>

            <li>Modified code to display a different color on the monitor (red) 8'b111_000_00</li>
            <li>Drew a green square on a yellow background on the display 
            <br>
            <img src="https://github.com/sk2282/ECE3400_Team8/blob/master/pictures/Lab3/GraphicsSquare.jpg?raw=true" height="300" />
            </li>
          </ul>


        <h5>2. Modify code to display a 2x2 grid:</h5>
          <ul>
            <li>Created a 2x2 register array with each value as 8 bits called grid_array which stores the colors</li>
            <li>Check which grid a pixel is in and assign the grid whichever color corresponds to it in grid_array</li>
            <li>Set PIXEL_COLOR to the corresponding color in grid_array depending on what grid_coord_x and grid_coord_y are (00, 01, 10, 11) 

              <pre>
              //2-by-2 array of bits
              reg [7:0] grid_array [1:0][1:0]; //[rows][columns]
              reg [1:0] grid_coord_x; //Index x into the array
              reg [1:0] grid_coord_y; //Index y into the array
              // current highlighted square
              wire highlighted_x;
              wire highlighted_y;  
              //Switch input through GPIO pins
              assign highlighted_x = GPIO_0_D[33];
              assign highlighted_y = GPIO_0_D[31];
              </pre>

            <br>
            <img src="https://github.com/sk2282/ECE3400_Team8/blob/master/pictures/Lab3/BothGrids.png?raw=true" height="100" />
            </li>

            <li>Set PIXEL_COLOR to background color if pixel is not within the 2x2 grids</li>
          </ul>

        <h5>3. Modify code to change grid color from the two switches:</h5>
            <ul>
              <li>Use highlighted_x and highlighted_y to modify the colors in grid_array

                <pre>
                always @ (*) begin
                  if (highlighted_x==0 && highlighted_y==0) begin
                    grid_array[0][0]<=8'b111_000_00;
                    grid_array[0][1]<=8'b000_111_00;
                    grid_array[1][0]<=8'b000_111_00;
                    grid_array[1][1]<=8'b000_111_00;
                  end
                  if (highlighted_x==0 && highlighted_y==1) begin
                    grid_array[0][0]<=8'b000_111_00;
                    grid_array[0][1]<=8'b111_000_00;
                    grid_array[1][0]<=8'b000_111_00;
                    grid_array[1][1]<=8'b000_111_00;
                  end
                  if (highlighted_x==1 && highlighted_y==0) begin
                    // etc... not shown for sake of briefness
                  end
                  if (highlighted_x==1 && highlighted_y==1) begin
                    // etc
                  end
                end
                </pre>
              </li>

              <li>First tested this by manually changing values of highlighted_x and highlighted_y</li>
              <li>Next, we wired up a circuit connecting the FPGA to an Arduino with 2 switches so that toggling the switches would modify the grid on the VGA display by setting highlighted_x and y based on these switches</li>
              <li>We wrote a simple Arduino sketch to output 5V when the switch is 1 and 0V when the switch is 0

                <pre>
                int readSwitch1 = 11;
                int writeSwitch1 = 10;
                int readSwitch2 = 2;
                int writeSwitch2 = 1;

                void setup() {
                  // put your setup code here, to run once:
                  pinMode(readSwitch1, INPUT);
                  pinMode(writeSwitch1, OUTPUT);
                  pinMode(readSwitch2, INPUT);
                  pinMode(writeSwitch2, OUTPUT);

                }

                void loop() {
                  // put your main code here, to run repeatedly:
                  if (digitalRead(readSwitch1) == 1) {
                    digitalWrite(writeSwitch1, HIGH);
                  }
                  else if (digitalRead(readSwitch1) == 0) {
                    digitalWrite(writeSwitch1, LOW);
                  }
                  if (digitalRead(readSwitch2) == 1) {
                    digitalWrite(writeSwitch2, HIGH);
                  }
                  else if (digitalRead(readSwitch2) == 0) {
                    digitalWrite(writeSwitch2, LOW);
                  }

                }
                </pre>
              </li>

              <li>Before testing the code, we first tested the voltage divider and two switches with a multimeter to verify our circuit</li>
              <li>The switch tells the arduino what to output which is then sent through the voltage divider and connected to the FPGA to set the highlighted_x and highlighted_y values. </li>
              <li><a href="https://youtu.be/8U0nGZCbZIM">Initially we didn’t ground everything properly, so our display was a bit strange, but once we fixed that our screen showed the highlighted square changing grids when the switches were toggled.</a></li>
          </ul>

        <h4>Audio Team:</h4>
        Materials Used:
          <ul>
            <li>FPGA</li>
            <li>Arduino</li>
            <li>Lab Speaker</li>
            <li>Stereo Phone Jack Socket</li>
            <li>8-bit R2R DAC</li>
          </ul>

        <h4>Procedure:</h4>
          <ol>
            <li>Generate and play a square wave of a desired frequency</li>
            <li>Generate a more complicated waveform and play sound using the 8-bit DAC</li>
            <li>Turn on/off your sound with an enable signal</li>
            <li>Make a tune with at least three frequencies that plays when you receive a done signal from the Arduino</li>
          </ol>

        <h5>1. Generate and play a square wave of a desired frequency</h5>
          <ul>
            <li>This was done by using one GPIO pin. We toggled this pin high and low (0 and 1) based on a clock input. We chose to to create a 1kHz Square wave. The FPGA’s clock runs at 50MHz and the example code showed us how to set up a 25MHz clock by toggling a variable every other time. We used the 25MHz clock and used a clock divider to get our desired frequency and set up a 1kHz clock.

              <pre>
              // Local parameter
              localparam CLKDIVIDER_1k = 25000000/1000;

              // Sound variables
              reg square_1k;                    
              assign GPIO_0_D[7:0] = signal;
              reg [15:0] counter;

              // Sound state machine
              always @ (posedge CLOCK_25) begin
                if (counter == 0) begin
                  counter    <= CLKDIVIDER_1k - 1; 
                  square_1k <= ~square_1k;   
                end
                else begin
                  counter    <= counter - 1;
                  square_1k <= square_1k;
                end
              end
              </pre>
            </li>

            <li>Above is the code we used to create the square wave. Every time a change was detected in the 1kHz clock, the output would be toggled so a square wave would be generated. Pictured below is our waveform.
            <br>
            <img src="https://github.com/sk2282/ECE3400_Team8/blob/master/pictures/Lab3/1kHz_square_wave.bmp?raw=true" height="300" />
            </li>

          </ul>

        <h5>2. Generate a more complicated waveform and play sound using the 8-bit DAC</h5>
          <ul>
            <li>For a more complicated waveform, we chose to make a 1kHz  triangle wave. To do this we set up an 8 bit output signal and started at 0. Then when we reached a peak, we decremented back to zero and started again. The code and waveform for this is pictured below. 

              <pre>
              // 1000 Hz square wave
              localparam CLKDIVIDER_1k = 25000000/1000;
              reg square_1k;
              reg [7:0] signal;
              assign GPIO_0_D[7:0] = signal;
              reg [15:0] counter;
               
              always @(posedge CLOCK_25) begin
                if (counter == 0)
                begin
                  counter <= CLKDIVIDER_1k - 1;
                  signal <= signal + 1;
                end
                else if (counter <= CLKDIVIDER_1k / 2)
                begin
                  counter <= counter - 1;
                  signal <= signal - 1;
                end
                else
                begin
                  counter <= counter - 1;
                  signal <= signal + 1;
                end
                 end
              </pre>

            <br>
            <img src="https://github.com/sk2282/ECE3400_Team8/blob/master/pictures/Lab3/1kHz_triangle_wave.bmp?raw=true" height="300" />
            </li>

            <li>In the waveform, we noticed that the oscilloscope wasn't reading 1kHz. We were able to tell though that it was fine by looking at the time division on the bottom of the screen and seeing the length per period of the wave. We also noticed that we were getting a lot of noise in the waveform, and were not able to determine why.  </li>

            <li>The Digital to Analog Converter (DAC) we used has 8 inputs. Each of these correspond to a bit. The DAC takes these bits and creates an 8 bit analog signal, which is then output through one pin as a varying voltage.

            <br>
            <img src="https://github.com/sk2282/ECE3400_Team8/blob/master/pictures/Lab3/dac.jpg?raw=true" height="300" />
            </li>

            <li>This voltage is connected to the input to the audio jack, which  in turn makes the speakers play.</li>
          </ul>

        <h5>3. Turn on/off your sound with an enable signal</h5>
          <ul>
            <li>The FPGA reads in the signal from the Arduino in the input pin GPIO_0_IN[0], polling every second.  If GPIO_0_IN[0] is HIGH, the start tone arpeggio plays. </li> 

            <li>To <a href="https://youtu.be/X0OTrH7R2Bw">test this functionality</a>, we repeatedly sent two-second signal pulses from digital pin 2, set apart by 5 seconds.</li>  

            <li>Below is the code we used to output the signal from the Arduino to the FPGA.

              <pre>
              void setup() {
                // put your setup code here, to run once:
                pinMode(2, OUTPUT);
                Serial.begin(9600);
                digitalWrite(2,LOW);
              }

              void loop() {
                // put your main code here, to run repeatedly:
                delay(5000);
                Serial.println("done");
                digitalWrite(2, HIGH);
                delay(2000);
                digitalWrite(2, LOW);
                Serial.println("done signal off");
              }
              </pre>
            </li>

            <li>Below is the section of the code for the FPGA that we needed to edit in order for the sound to play when it received the done signal.

              <pre>
              always @(posedge CLK_1s) begin
                if (GPIO_0_IN[0] || (soundCount > 3'b0 && soundCount <= 3'd3)) begin
                  if (soundCount <= 3'd3) begin
                    soundCount <= soundCount + 1;
                  end
                  else begin
                    soundCount <= soundCount;
                  end
                end 
                else begin
                  soundCount <= 3'b0;
                end
               end
              </pre>
            </li>
          </ul>

        <h5>4. Make a tune with at least three frequencies that plays when you receive a done signal from the Arduino</h5>
          <ul>
            <li>We made an arpeggio by generating a sine wave in matlab and sampling it at different rates with different clock cycles (1000, 1250, and 1500 Hz) and <a href="https://youtu.be/WXv8SHkbqRc">played each tone for one second each</a>.  
            <br>
            <img src="https://github.com/sk2282/ECE3400_Team8/blob/master/pictures/Lab3/1kHz_sin_wave.bmp?raw=true" height="300" />
            </li>

            <li>The above wave form shows an inconsitency in the waveform that occurs in the same location in each cycle. Due to this the tone was not as clear. Since this problem was so consistent, we turned to our sine table to look for a possible cause. We then realized that while out sine table only had 8-bit values, it was ranged between 0 and 256. This meant that every time it went out of bounds, we were going to get a deiscrepancy. Once we fixed the few balues that were out of bounds we were able to play a clear sine wave and move on to generating multiple frequencies.  </li>

            <li>To generate the tones, we used a counter for each respective sampling frequency to traverse the sine table and produce the signal to the output. </li> 

            <li>We used another counter to keep track of the signal that was currently playing. This counter increments every second to change the sampling frequency and change the tone playing as a result. Once the counter reaches 4, we stop playing the tone.  </li>

            <li>The tones only begin playing when the board receives a signal from the Arduino.</li>  
          </ul>


      </div>
    </div>
    </div>
    <footer class="container-fluid text-center bg-blk txt-white">
      <a href="#myPage" title="To Top">
        <span class="glyphicon glyphicon-chevron-up"></span>
      </a>
      <table style="border-style:none" width="100%" height="100px">
      <tr>
        <td width="35%" />
        <td width="30%">
          <p>
            <img src="https://raw.githubusercontent.com/sk2282/ECE3400_Team8/master/pictures/General/BB-8.png" style="height:52px" align:"left" />
            Site maintained by <a href="https://github.com/sk2282/ECE3400_Team8">ECE 3400 Team 8</a>
            <br><br>
            Theme Made Using <a href="http://getbootstrap.com/"> Bootstrap</a>
          </p>
        </td>
        <td width="35%" />
      </tr>
    </footer>

    <!-- SMOOTH SCROLL -->
    <script>
      $(document).ready(function(){
        // Add smooth scrolling to all links in navbar + footer link
        $(".navbar a, footer a[href='#myPage'], header a[href='#content']").on('click', function(event) {

         // Make sure this.hash has a value before overriding default behavior
        if (this.hash !== "") {

          // Prevent default anchor click behavior
          event.preventDefault();

          // Store hash
          var hash = this.hash;

          // Using jQuery's animate() method to add smooth page scroll
          // The optional number (900) specifies the number of milliseconds it takes to scroll to the specified area
          $('html, body').animate({
            scrollTop: $(hash).offset().top
          }, 900, function(){

            // Add hash (#) to URL when done scrolling (default click behavior)
            window.location.hash = hash;
            });
          } // End if
        });
      })
    </script>
    
  </body>
  
</html>
